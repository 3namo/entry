<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>é¸è€ƒçŠ¶æ³ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <style>
    :root {
      --border-color: #ddd; --bg-color: #f4f7f6; --bg-alt-color: #fff;
      --text-color: #333; --accent-color: #007bff; --danger-color: #e74c3c;
    }
    body { font-family: 'Segoe UI', Meiryo, sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); }
    .container { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    h1, h2 { text-align: center; color: #444; }
    h2 { font-size: 1.2rem; margin-top: 2.5rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin: 1.5rem 0; flex-wrap: wrap; gap: 1rem; }
    .search-bar { flex-grow: 1; min-width: 200px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 20px; }
    .toolbar-group { display: flex; gap: 0.5rem; }
    .toolbar-btn {
      padding: 0.5rem 1rem; border: 1px solid var(--border-color); background-color: var(--bg-alt-color);
      border-radius: 20px; cursor: pointer; transition: background-color 0.2s, color 0.2s;
    }
    .toolbar-btn:hover { background-color: #e9ecef; }
    #company-list, #archived-list { margin-top: 1rem; }
    .company-item {
      background-color: var(--bg-alt-color); border: 1px solid var(--border-color);
      border-left-width: 5px; border-radius: 8px; margin-bottom: 1rem; transition: box-shadow 0.2s;
    }
    .item-summary { display: flex; align-items: center; gap: 1rem; padding: 0.5rem 1rem; cursor: pointer; }
    .company-name {
        font-weight: bold; font-size: 1.1rem; flex-grow: 1;
        cursor: pointer; padding: 0.25rem; border-radius: 4px;
    }
    .company-name:hover { background-color: #f0f0f0; } /* å¾©æ´» */
    .status-select { padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; min-width: 120px; }
    .menu-container { position: relative; }
    .kebab-btn { font-size: 1.5rem; font-weight: bold; background: none; border: none; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; }
    .kebab-btn:hover { background-color: #f0f0f0; }
    .kebab-menu {
      display: none; position: absolute; right: 0; top: 100%; background: white;
      border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 10; list-style: none; padding: 0.5rem 0; margin: 0; min-width: 150px;
    }
    .kebab-menu.show { display: block; }
    .kebab-menu button {
      display: block; width: 100%; text-align: left; padding: 0.75rem 1rem;
      border: none; background: none; cursor: pointer;
    }
    .kebab-menu button:hover { background-color: #f0f0f0; }
    .kebab-menu button.delete { color: var(--danger-color); }

    .item-details { padding: 0 1rem 1rem 1rem; border-top: 1px dashed var(--border-color); margin-top: 0.5rem; }
    .detail-grid { display: grid; gap: 1rem; grid-template-columns: 1fr 1fr; }
    .detail-field { display: flex; flex-direction: column; }
    .detail-field label { font-size: 0.8rem; color: #666; margin-bottom: 0.25rem; }
    .detail-field input { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; box-sizing: border-box; }
    .url-field { grid-column: 1 / -1; display: flex; align-items: center; gap: 0.5rem; }
    .url-link { font-size: 1.2rem; text-decoration: none; }
    .add-container { text-align: center; margin-top: 1rem; }
    #add-company-btn { background-color: var(--accent-color); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 2rem; cursor: pointer; line-height: 50px; transition: background-color 0.2s; }
    #add-company-btn:hover { background-color: #0056b3; }
    #add-company-form { display: none; gap: 0.5rem; justify-content: center; align-items: center; padding: 1rem; background-color: #fff; border-radius: 8px; border: 1px solid var(--border-color); }
    #new-company-name { padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; flex-grow: 1; max-width: 400px; }
    .form-btn { padding: 0.5rem 1.2rem; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .add-new-btn { background-color: var(--accent-color); color: white; }
    .cancel-add-btn { background-color: #6c757d; color: white; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-content h3 { margin-top: 0; }
    #status-options-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; }
    #status-options-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--border-color); cursor: move; }
    #status-options-list li .delete-btn:hover { color: var(--danger-color); }
    #add-status-form { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .modal-footer { margin-top: 1.5rem; text-align: right; }
  </style>
</head>
<body>
  <div class="container">
    <h1>é¸è€ƒçŠ¶æ³ç®¡ç†</h1>
    <div class="toolbar">
      <input type="search" id="search-bar" class="search-bar" placeholder="ä¼æ¥­åã‚’æ¤œç´¢...">
      <div class="toolbar-group">
        <button id="manage-status-btn" class="toolbar-btn">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†</button>
        <button id="sort-by-name" class="toolbar-btn">åå‰é †</button>
        <button id="sort-by-date" class="toolbar-btn">äºˆå®šæ—¥é †</button>
      </div>
    </div>
    <div id="company-list"></div>
    <div class="add-container">
      <button id="add-company-btn" title="ä¼æ¥­ã‚’è¿½åŠ ">+</button>
      <form id="add-company-form"><input type="text" id="new-company-name" placeholder="ä¼æ¥­åã‚’å…¥åŠ›" required><button type="submit" class="form-btn add-new-btn">è¿½åŠ </button><button type="button" id="cancel-add-btn" class="form-btn cancel-add-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></form>
    </div>

    <div id="archive-section" style="display: none;">
        <h2>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ãƒªã‚¹ãƒˆ</h2>
        <div id="archived-list"></div>
    </div>
    <div style="text-align: center; margin: 1rem 0;">
        <button id="toggle-archive-btn" class="toolbar-btn">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º</button>
    </div>

    <h2>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
    <div class="toolbar">
        <button id="export-data-btn" class="toolbar-btn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <input type="file" id="import-file-input" style="display: none;">
        <button id="import-data-btn" class="toolbar-btn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    </div>
  </div>

  <div class="modal-overlay" id="manage-status-modal">
    <div class="modal-content">
      <h3>é¸è€ƒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç®¡ç†</h3>
      <p>ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ä¸¦ã³æ›¿ãˆãŒã§ãã¾ã™ã€‚</p>
      <ul id="status-options-list"></ul>
      <form id="add-status-form"><input type="text" id="new-status-name" placeholder="æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å" required style="flex-grow:1; padding: 0.5rem;"><button type="submit" class="form-btn add-new-btn">è¿½åŠ </button></form>
      <div class="modal-footer"><button id="close-modal-btn" class="toolbar-btn">é–‰ã˜ã‚‹</button></div>
    </div>
  </div>
  
  <div id="toast-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const companyList = document.getElementById('company-list');
      const archivedList = document.getElementById('archived-list');
      const addCompanyBtn = document.getElementById('add-company-btn');
      const sortByNameBtn = document.getElementById('sort-by-name');
      const sortByDateBtn = document.getElementById('sort-by-date');
      const addCompanyForm = document.getElementById('add-company-form');
      const newCompanyNameInput = document.getElementById('new-company-name');
      const cancelAddBtn = document.getElementById('cancel-add-btn');
      const manageStatusBtn = document.getElementById('manage-status-btn');
      const modal = document.getElementById('manage-status-modal');
      const closeModalBtn = document.getElementById('close-modal-btn');
      const statusOptionsList = document.getElementById('status-options-list');
      const addStatusForm = document.getElementById('add-status-form');
      const newStatusNameInput = document.getElementById('new-status-name');
      const searchBar = document.getElementById('search-bar');
      const archiveSection = document.getElementById('archive-section');
      const toggleArchiveBtn = document.getElementById('toggle-archive-btn');
      const exportBtn = document.getElementById('export-data-btn');
      const importBtn = document.getElementById('import-data-btn');
      const importFileInput = document.getElementById('import-file-input');
      const toastContainer = document.getElementById('toast-container');

      const DATA_KEY = 'jobAppData_v7'; // å¿µã®ãŸã‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—

      const defaultStatusOptions = ["æœªã‚¨ãƒ³ãƒˆãƒªãƒ¼", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆã¿", "æ›¸é¡é¸è€ƒ", "ã‚¦ã‚£ãƒ³ã‚¿ãƒ¼é€šé", "ã‚µãƒãƒ¼é€šé", "Webãƒ†ã‚¹ãƒˆ", "1æ¬¡é¢æ¥å‰", "1æ¬¡é¢æ¥çµæœå¾…ã¡", "1æ¬¡é¢æ¥é€šé", "2æ¬¡é¢æ¥å‰", "2æ¬¡é¢æ¥çµæœå¾…ã¡", "2æ¬¡é¢æ¥é€šé", "æœ€çµ‚é¢æ¥å‰", "æœ€çµ‚é¢æ¥çµæœå¾…ã¡", "å†…ã€…å®š", "å†…å®š", "ãŠç¥ˆã‚Š"];
      const statusColors = {"å†…ã€…å®š": "#28a745", "å†…å®š": "#28a745", "æœ€çµ‚é¢æ¥çµæœå¾…ã¡": "#17a2b8", "æœ€çµ‚é¢æ¥å‰": "#17a2b8", "2æ¬¡é¢æ¥é€šé": "#007bff", "1æ¬¡é¢æ¥é€šé": "#007bff", "ãŠç¥ˆã‚Š": "#6c757d", "æ›¸é¡é¸è€ƒ": "#ffc107"};

      let appData = { companies: [], statusOptions: defaultStatusOptions };

      const loadData = () => {
          const savedData = localStorage.getItem(DATA_KEY);
          if (savedData) appData = JSON.parse(savedData);
      };
      const saveData = () => localStorage.setItem(DATA_KEY, JSON.stringify(appData));

      const render = () => {
        const searchTerm = searchBar.value.toLowerCase();
        renderCompanyList(companyList, appData.companies.filter(c => !c.archived), searchTerm);
        renderCompanyList(archivedList, appData.companies.filter(c => c.archived), searchTerm, true);
      };

      const renderCompanyList = (listElement, companies, searchTerm, isArchived = false) => {
        const filteredCompanies = companies.filter(c => c.name.toLowerCase().includes(searchTerm));
        listElement.innerHTML = filteredCompanies.length === 0 ? `<p style="text-align:center; color:#888;">${searchTerm ? 'è©²å½“ãªã—' : 'ä¼æ¥­ãªã—'}</p>` : '';
        
        filteredCompanies.forEach(company => {
          const companyEl = document.createElement('details');
          companyEl.classList.add('company-item');
          companyEl.dataset.id = company.id;
          companyEl.style.borderLeftColor = statusColors[company.status] || '#ccc';
          const optionsHtml = appData.statusOptions.map(o => `<option value="${o}" ${company.status === o ? 'selected' : ''}>${o}</option>`).join('');
          const archiveMenuText = isArchived ? 'ãƒªã‚¹ãƒˆã«æˆ»ã™' : 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–';
          companyEl.innerHTML = `
            <summary class="item-summary">
              <span class="company-name">${company.name}</span>
              <select class="status-select">${optionsHtml}</select>
              <div class="menu-container">
                  <button class="kebab-btn" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â‹®</button>
                  <div class="kebab-menu">
                      <button class="menu-item-archive">${archiveMenuText}</button>
                      <button class="menu-item-delete delete">å®Œå…¨ã«å‰Šé™¤</button>
                  </div>
              </div>
            </summary>
            <div class="item-details">
              <div class="detail-grid">
                <div class="detail-field"><label>ID/Email</label><input type="text" class="login-id" value="${company.loginId || ''}"></div>
                <div class="detail-field"><label>ä¸€è¡Œãƒ¡ãƒ¢</label><input type="text" class="memo-input" value="${company.memo || ''}"></div>
                <div class="detail-field"><label>æ¬¡å›ã®äºˆå®šæ—¥</label><input type="date" class="next-date" value="${company.nextDate || ''}"></div>
                <div class="detail-field url-field" style="grid-column: 1 / -1;"><label>æ¡ç”¨URL</label><input type="url" class="url-input" value="${company.url || ''}"><a href="${company.url || '#'}" target="_blank" class="url-link">ğŸ”—</a></div>
              </div>
            </div>`;
          listElement.appendChild(companyEl);
        });
      };
      
      const renderStatusOptionsInModal = () => { /* ... å¤‰æ›´ãªã— ... */ };
      
      const showToast = (message) => {
          const toast = document.createElement('div');
          toast.className = 'toast';
          toast.textContent = message;
          toastContainer.appendChild(toast);
          setTimeout(() => { toast.remove(); }, 3000);
      };

      companyList.addEventListener('change', handleCompanyDataChange);
      archivedList.addEventListener('change', handleCompanyDataChange);
      function handleCompanyDataChange(e) { /* ... å¤‰æ›´ãªã— ... */ }

      // â–¼â–¼â–¼ å¤‰æ›´ç‚¹ï¼šã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†ã‚’ä¿®æ­£ â–¼â–¼â–¼
      const handleListClick = (e) => {
          const companyNameSpan = e.target.closest('.company-name');
          const kebabBtn = e.target.closest('.kebab-btn');
          const menuItemArchive = e.target.closest('.menu-item-archive');
          const menuItemDelete = e.target.closest('.menu-item-delete');
          
          if (companyNameSpan) {
              e.preventDefault(); // ã“ã‚ŒãŒé‡è¦ï¼è©³ç´°ã®é–‹é–‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              const itemEl = e.target.closest('.company-item');
              const nameSpan = itemEl.querySelector('.company-name');
              const currentName = nameSpan.textContent;
              const input = document.createElement('input');
              input.type = 'text'; input.value = currentName;
              input.style.cssText = 'font-weight: bold; font-size: 1.1rem; flex-grow: 1; border: 1px solid #007bff; padding: 0.25rem; border-radius: 4px;';
              nameSpan.replaceWith(input);
              input.focus();
              const saveNameChange = () => {
                  const newName = input.value.trim();
                  if (newName && newName !== currentName) {
                      const company = appData.companies.find(c => c.id == itemEl.dataset.id);
                      company.name = newName;
                      saveData();
                  }
                  render();
              };
              input.addEventListener('blur', saveNameChange);
              input.addEventListener('keydown', (event) => {
                  if (event.key === 'Enter') input.blur();
                  else if (event.key === 'Escape') { input.value = currentName; input.blur(); }
              });
          } else if (kebabBtn) {
              e.preventDefault();
              const menu = kebabBtn.nextElementSibling;
              const isShown = menu.classList.contains('show');
              // ä¸€æ—¦ã™ã¹ã¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
              document.querySelectorAll('.kebab-menu.show').forEach(m => m.classList.remove('show'));
              // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‚ã®ãŒé–‹ã„ã¦ã„ãªã‘ã‚Œã°é–‹ã
              if (!isShown) menu.classList.add('show');
          } else if (menuItemArchive) {
              const company = appData.companies.find(c => c.id == e.target.closest('.company-item').dataset.id);
              company.archived = !company.archived;
              saveData();
              render();
              showToast(`ã€Œ${company.name}ã€ã‚’${company.archived ? 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸ' : 'ãƒªã‚¹ãƒˆã«æˆ»ã—ã¾ã—ãŸ'}`);
          } else if (menuItemDelete) {
              const itemEl = e.target.closest('.company-item');
              const id = itemEl.dataset.id;
              const companyName = appData.companies.find(c => c.id == id).name;
              if (confirm(`ã€Œ${companyName}ã€ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                  appData.companies = appData.companies.filter(c => c.id != id);
                  saveData();
                  render();
                  showToast(`ã€Œ${companyName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
              }
          }
      };
      companyList.addEventListener('click', handleListClick);
      archivedList.addEventListener('click', handleListClick);
      
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      document.addEventListener('click', (e) => {
          if (!e.target.closest('.menu-container')) {
              document.querySelectorAll('.kebab-menu.show').forEach(menu => menu.classList.remove('show'));
          }
      });
      // â–²â–²â–² å¤‰æ›´ç‚¹ â–²â–²â–²

      addCompanyForm.addEventListener('submit', (e) => { /* ... å¤‰æ›´ãªã— ... */ });
      const showAddForm = () => { addCompanyBtn.style.display = 'none'; addCompanyForm.style.display = 'flex'; newCompanyNameInput.focus(); };
      const hideAddForm = () => { addCompanyBtn.style.display = 'inline-block'; addCompanyForm.style.display = 'none'; newCompanyNameInput.value = ''; };
      addCompanyBtn.addEventListener('click', showAddForm);
      cancelAddBtn.addEventListener('click', hideAddForm);

      sortByNameBtn.addEventListener('click', () => { appData.companies.sort((a,b) => a.name.localeCompare(b.name, 'ja')); render(); });
      sortByDateBtn.addEventListener('click', () => { appData.companies.sort((a,b) => { if (!a.nextDate) return 1; if (!b.nextDate) return -1; return new Date(a.nextDate) - new Date(b.nextDate); }); render(); });

      manageStatusBtn.addEventListener('click', () => { renderStatusOptionsInModal(); modal.style.display = 'flex'; });
      closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
      addStatusForm.addEventListener('submit', (e) => { /* ... å¤‰æ›´ãªã— ... */ });
      statusOptionsList.addEventListener('click', (e) => { /* ... å¤‰æ›´ãªã— ... */ });
      new Sortable(statusOptionsList, { /* ... å¤‰æ›´ãªã— ... */ });
      
      searchBar.addEventListener('input', render);
      toggleArchiveBtn.addEventListener('click', () => { /* ... å¤‰æ›´ãªã— ... */ });
      exportBtn.addEventListener('click', () => { /* ... å¤‰æ›´ãªã— ... */ });
      importBtn.addEventListener('click', () => importFileInput.click());
      importFileInput.addEventListener('change', (e) => { /* ... å¤‰æ›´ãªã— ... */ });

      loadData();
      render();
    });
  </script>
</body>
</html>
