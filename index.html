<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>選考状況管理ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <style>
    :root {
      --border-color: #ddd; --bg-color: #f4f7f6; --bg-alt-color: #fff;
      --text-color: #333; --accent-color: #007bff; --danger-color: #e74c3c;
    }
    body { font-family: 'Segoe UI', Meiryo, sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); }
    .container { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    h1 { text-align: center; color: #444; }
    .toolbar { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; margin: 1.5rem 0; flex-wrap: wrap; }
    .sort-btn, .manage-btn {
      padding: 0.5rem 1rem; border: 1px solid var(--border-color); background-color: var(--bg-alt-color);
      border-radius: 20px; cursor: pointer; transition: background-color 0.2s, color 0.2s;
    }
    .sort-btn:hover, .manage-btn:hover { background-color: #e9ecef; }
    #company-list { margin-top: 1rem; }
    .company-item {
      background-color: var(--bg-alt-color); border: 1px solid var(--border-color);
      border-left-width: 5px; border-radius: 8px; margin-bottom: 1rem; transition: box-shadow 0.2s;
    }
    .company-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .item-summary { display: flex; align-items: center; gap: 1rem; padding: 1rem; cursor: pointer; }
    .company-name { font-weight: bold; font-size: 1.1rem; flex-grow: 1; }
    .status-select { padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; min-width: 120px; }
    .delete-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 1.5rem; padding: 0 0.5rem; transition: color 0.2s; }
    .delete-btn:hover { color: var(--danger-color); }
    .item-details { padding: 0 1rem 1rem 1rem; border-top: 1px dashed var(--border-color); margin-top: 0.5rem; }
    .detail-grid { display: grid; gap: 1rem; grid-template-columns: 1fr 1fr; }
    .detail-field { display: flex; flex-direction: column; }
    .detail-field label { font-size: 0.8rem; color: #666; margin-bottom: 0.25rem; }
    .detail-field input { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; box-sizing: border-box; }
    .url-field { grid-column: 1 / -1; display: flex; align-items: center; gap: 0.5rem; }
    .url-link { font-size: 1.2rem; text-decoration: none; }
    .add-container { text-align: center; margin-top: 1rem; }
    #add-company-btn { background-color: var(--accent-color); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 2rem; cursor: pointer; line-height: 50px; transition: background-color 0.2s; }
    #add-company-btn:hover { background-color: #0056b3; }
    #add-company-form { display: none; gap: 0.5rem; justify-content: center; align-items: center; padding: 1rem; background-color: #fff; border-radius: 8px; border: 1px solid var(--border-color); }
    #new-company-name { padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; flex-grow: 1; max-width: 400px; }
    .form-btn { padding: 0.5rem 1.2rem; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .add-new-btn { background-color: var(--accent-color); color: white; }
    .cancel-add-btn { background-color: #6c757d; color: white; }

    /* ▼▼▼ ステータス管理モーダル ▼▼▼ */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; }
    .modal-content h3 { margin-top: 0; }
    #status-options-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; }
    #status-options-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--border-color); cursor: move; /* 変更点: カーソル */ }
    #status-options-list li:last-child { border-bottom: none; }
    #add-status-form { display: flex; gap: 0.5rem; margin-top: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>選考状況管理</h1>
    <div class="toolbar">
      <button id="manage-status-btn" class="manage-btn">ステータスを管理</button>
      <div>
        <button id="sort-by-name" class="sort-btn">名前順</button>
        <button id="sort-by-date" class="sort-btn">予定日順</button>
      </div>
    </div>
    <div id="company-list"></div>
    <div class="add-container">
      <button id="add-company-btn" title="企業を追加">+</button>
      <form id="add-company-form"><input type="text" id="new-company-name" placeholder="企業名を入力" required><button type="submit" class="form-btn add-new-btn">追加</button><button type="button" id="cancel-add-btn" class="form-btn cancel-add-btn">キャンセル</button></form>
    </div>
  </div>

  <div class="modal-overlay" id="manage-status-modal">
    <div class="modal-content">
      <h3>選考ステータスの管理</h3>
      <p>ドラッグ＆ドロップで並び替えができます。</p>
      <ul id="status-options-list"></ul>
      <form id="add-status-form">
        <input type="text" id="new-status-name" placeholder="新しいステータス名" required style="flex-grow:1; padding: 0.5rem;">
        <button type="submit" class="form-btn add-new-btn">追加</button>
      </form>
      <button id="close-modal-btn" style="margin-top: 1rem;">閉じる</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const companyList = document.getElementById('company-list');
      const addCompanyBtn = document.getElementById('add-company-btn');
      const sortByNameBtn = document.getElementById('sort-by-name');
      const sortByDateBtn = document.getElementById('sort-by-date');
      const addCompanyForm = document.getElementById('add-company-form');
      const newCompanyNameInput = document.getElementById('new-company-name');
      const cancelAddBtn = document.getElementById('cancel-add-btn');
      const manageStatusBtn = document.getElementById('manage-status-btn');
      const modal = document.getElementById('manage-status-modal');
      const closeModalBtn = document.getElementById('close-modal-btn');
      const statusOptionsList = document.getElementById('status-options-list');
      const addStatusForm = document.getElementById('add-status-form');
      const newStatusNameInput = document.getElementById('new-status-name');

      const COMPANY_KEY = 'myJobApplications_v4';
      const STATUS_KEY = 'jobApp_statusOptions_v4';

      const defaultStatusOptions = ["未エントリー", "エントリー済み", "書類選考", "Webテスト", "サマー通過", "ウィンター通過", "1次面接前", "1次面接通過", "2次面接前", "2次面接通過", "最終面接前", "最終面接通過", "内々定", "内定", "お祈り"];
      const statusColors = {"内々定": "#28a745", "最終面接": "#17a2b8", "2次面接": "#007bff", "1次面接": "#007bff", "お祈り": "#6c757d", "書類選考": "#ffc107"};

      let companies = JSON.parse(localStorage.getItem(COMPANY_KEY)) || [];
      let statusOptions = JSON.parse(localStorage.getItem(STATUS_KEY)) || defaultStatusOptions;

      const saveCompanies = () => localStorage.setItem(COMPANY_KEY, JSON.stringify(companies));
      const saveStatusOptions = () => localStorage.setItem(STATUS_KEY, JSON.stringify(statusOptions));

      const renderCompanies = () => {
        companyList.innerHTML = companies.length === 0 ? '<p style="text-align:center; color:#888;">下の「+」ボタンから企業を追加してください。</p>' : '';
        companies.forEach(company => {
          const companyEl = document.createElement('details');
          companyEl.classList.add('company-item');
          companyEl.dataset.id = company.id;
          companyEl.style.borderLeftColor = statusColors[company.status] || '#ccc';
          const optionsHtml = statusOptions.map(o => `<option value="${o}" ${company.status === o ? 'selected' : ''}>${o}</option>`).join('');
          companyEl.innerHTML = `
            <summary class="item-summary">
              <span class="company-name">${company.name}</span>
              <select class="status-select">${optionsHtml}</select>
              <button class="delete-btn" title="削除">&times;</button>
            </summary>
            <div class="item-details">
              <div class="detail-grid">
                <div class="detail-field"><label>ID/Email</label><input type="text" class="login-id" value="${company.loginId || ''}"></div>
                <div class="detail-field"><label>一行メモ</label><input type="text" class="memo-input" value="${company.memo || ''}"></div>
                <div class="detail-field"><label>次回の予定日</label><input type="date" class="next-date" value="${company.nextDate || ''}"></div>
                <div class="detail-field url-field" style="grid-column: 1 / -1;"><label>採用URL</label><input type="url" class="url-input" value="${company.url || ''}"><a href="${company.url || '#'}" target="_blank" class="url-link">🔗</a></div>
              </div>
            </div>`;
          companyList.appendChild(companyEl);
        });
      };
      
      const renderStatusOptionsInModal = () => {
          statusOptionsList.innerHTML = '';
          statusOptions.forEach(name => {
              const li = document.createElement('li');
              li.innerHTML = `<span>${name}</span><button data-name="${name}" class="delete-btn">&times;</button>`;
              statusOptionsList.appendChild(li);
          });
      };

      companyList.addEventListener('change', (e) => {
          const itemEl = e.target.closest('.company-item');
          if (!itemEl) return;
          const company = companies.find(c => c.id == itemEl.dataset.id);
          const propMap = {'status-select':'status', 'login-id':'loginId', 'next-date':'nextDate', 'url-input':'url', 'memo-input':'memo'};
          for (const [cls, prop] of Object.entries(propMap)) {
              if (e.target.classList.contains(cls)) {
                  company[prop] = e.target.value;
                  if(cls === 'status-select') itemEl.style.borderLeftColor = statusColors[company.status] || '#ccc';
                  if(cls === 'url-input') itemEl.querySelector('.url-link').href = e.target.value || '#';
                  break;
              }
          }
          saveCompanies();
      });
      companyList.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-btn')) {
          e.preventDefault();
          const itemEl = e.target.closest('.company-item');
          const id = itemEl.dataset.id;
          const companyName = itemEl.querySelector('.company-name').textContent;
          if (confirm(`「${companyName}」を削除しますか？`)) {
            companies = companies.filter(c => c.id != id);
            saveCompanies();
            renderCompanies();
          }
        }
      });
      addCompanyForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const companyName = newCompanyNameInput.value.trim();
        if (companyName) {
          companies.push({ id: Date.now(), name: companyName, loginId: '', status: statusOptions[0], url: '', nextDate: '', memo: '' });
          saveCompanies();
          renderCompanies();
          hideAddForm();
        }
      });
      const showAddForm = () => { addCompanyBtn.style.display = 'none'; addCompanyForm.style.display = 'flex'; newCompanyNameInput.focus(); };
      const hideAddForm = () => { addCompanyBtn.style.display = 'inline-block'; addCompanyForm.style.display = 'none'; newCompanyNameInput.value = ''; };
      addCompanyBtn.addEventListener('click', showAddForm);
      cancelAddBtn.addEventListener('click', hideAddForm);

      sortByNameBtn.addEventListener('click', () => { companies.sort((a,b) => a.name.localeCompare(b.name, 'ja')); renderCompanies(); });
      sortByDateBtn.addEventListener('click', () => { companies.sort((a,b) => { if (!a.nextDate) return 1; if (!b.nextDate) return -1; return new Date(a.nextDate) - new Date(b.nextDate); }); renderCompanies(); });

      // --- ▼▼▼ ステータス管理（並び替え機能を含む） ▼▼▼ ---
      manageStatusBtn.addEventListener('click', () => { renderStatusOptionsInModal(); modal.style.display = 'flex'; });
      closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
      
      addStatusForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const newName = newStatusNameInput.value.trim();
          if (newName && !statusOptions.includes(newName)) {
              statusOptions.push(newName);
              saveStatusOptions();
              renderStatusOptionsInModal();
              renderCompanies();
              newStatusNameInput.value = '';
          }
      });
      statusOptionsList.addEventListener('click', (e) => {
          if (e.target.classList.contains('delete-btn')) {
              const statusToDelete = e.target.dataset.name;
              if (confirm(`ステータス「${statusToDelete}」を削除しますか？`)) {
                  statusOptions = statusOptions.filter(name => name !== statusToDelete);
                  saveStatusOptions();
                  renderStatusOptionsInModal();
                  renderCompanies();
              }
          }
      });

      // 並び替えの初期化
      new Sortable(statusOptionsList, {
          animation: 150,
          onEnd: (evt) => {
              // statusOptions配列の順序を更新
              const [movedItem] = statusOptions.splice(evt.oldIndex, 1);
              statusOptions.splice(evt.newIndex, 0, movedItem);
              
              // 新しい順序を保存し、メインリストのドロップダウンに反映
              saveStatusOptions();
              renderCompanies();
          }
      });
      // --- ▲▲▲ 変更点 ▲▲▲ ---

      renderCompanies();
    });
  </script>
</body>
</html>
